<!doctype html><html lang=zh-cn><title>Proxmox OpenVZ 虚拟机部属 IPv6 地址 - imlonghao</title><meta name=description content="最近趁着 Dacentec 的特价服务器上架了，趁机上了一台来玩耍。机子总体的性能还过得去，毕竟一分钱一分货，钱没到位货就不能要求太高。一开始装机的时候，是给了 IP-KVM 让我自行安装的，然而组了软 Raid1 然后 Debian / Ubuntu 等系统我都没做好启动的设置，所以干脆直接就安装了 Proxmax 这个虚拟化系统。"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=renderer content="webkit"><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><link rel=dns-prefetch href=//vip1.loli.net><link rel=stylesheet href=/static/hw3x7x.css><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqusjs.css integrity="sha256-GxdCIOyfxQ1OBfS99qAIJDoGK1ADuBsxhMTqXG82fAY=" crossorigin=anonymous><script src=/static/hw3x7x.js async></script><script src=https://cdn.jsdelivr.net/npm/disqusjs@1.3.0/dist/disqus.js integrity="sha256-LVaMHPQ2zLqOc5rXSAfr4d1PIkEGNLyyUTDNPZmTtUw=" crossorigin=anonymous></script><script src=//instant.page/3.0.0 type=module defer integrity=sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1></script><link rel=alternate type=application/rss+xml title="imlonghao Feed" href=https://imlonghao.com/feed.xml><div id=container><div id=header><div id=post-nav><a href=./>Home</a>
&nbsp;»&nbsp;
<a href=./44.html>Proxmox OpenVZ 虚拟机部属 IPv6 地址</a></div></div><div class=clearfix></div><div id=title>Proxmox OpenVZ 虚拟机部属 IPv6 地址</div><div id=content class=markdown-body><h2>前言</h2><p>最近趁着 Dacentec 的特价服务器上架了，趁机上了一台来玩耍。机子总体的性能还过得去，毕竟一分钱一分货，钱没到位货就不能要求太高。一开始装机的时候，是给了 IP-KVM 让我自行安装的，然而组了软 Raid1 然后 Debian / Ubuntu 等系统我都没做好启动的设置，所以干脆直接就安装了 Proxmax 这个虚拟化系统。<p>Proxmax 实际上就是基于 Debian 的一个包，为了方便安装官方打包成了 iso 镜像来给我们。安装过程挺顺利的，组好软 Raid1 然后就顺利的进到系统了。<p>虽然这台服务器的 IP 给的是 <code>/30</code> ，但是除去一个网关地址、一个广播地址，其实实际上能用的 IP 就只有一个，那么我要用 Proxmax 就只能用 nat 转发了。<p>后来，在 Dacentec 的 Wiki 上面搜了一下，发现是可以免费拿到一个 IPv6 段的，马上就去发了 Ticket ，然后，很快就有了回复，拿到了我可以用的 IPv6 地址。<p>下面就讲讲怎么把拿到的 IPv6 地址用上！<h2>步骤</h2><p>其实正如上面所说的，Proxmox 是基于 Debian 的，那么这篇教程理论上来讲也是适合单纯的 Debian 用户的。<h3>给 Host 配置 IPv6</h3><p>我们需要修改这个文件 <code>/etc/network/interfaces</code> ，把我们 IPv6 的地址配置上去<p>一般来说，在文件的最后加上下面的行就可以的了<pre><code>iface vmbr0 inet6 static
        address 2607:xxxx:xxxx:xxxx::2
        gateway 2607:xxxx:xxxx:xxxx::1
        netmask 64
</code></pre><p>服务器给我的是 IPv6 格式大概是这个样子的：<code>Network 2607:xxxx:xxxx:xxxx::/48</code><p>因此我只需要随便选择一个 IPv6 地址即可，所以我就选了 <code>2607:xxxx:xxxx:xxxx::2</code>， 然后将子网掩码设置成 <code>64</code><p>如果并不是 Proxmox 的用户的，就把 <code>vmbr0</code> 改为 <code>eth0</code> (改成你实际的网卡)<p>然后执行下面命令重启网络<pre><code>service networking restart
</code></pre><p>((如果配置有问题的话，那么你的机子应该就完全离线了&mldr;.<h3>测试 Host 的 IPv6</h3><p>测试也十分简单，只要 <code>ping</code> 一下几个地址就可以了。<ul><li>你的 IP<li>网关 IP<li>2001:4860:4860::8888 (Google Public DNS)<li>2001:4860:4860::8844 (Google Public DNS)</ul><p>如果都能 ping 通，那就证明没有问题了。<h3>配置系统</h3><h4>系统内核</h4><p>修改 <code>/etc/sysctl.conf</code> 文件，检查下面的行是否存在，如果存在就确保前面是没有注释的，如果不存在就新增加到最后<pre><code># IPv6 Packet Forwarding and Proxy NDP
net.ipv6.conf.default.forwarding = 1
net.ipv6.conf.all.forwarding = 1
net.ipv6.conf.default.proxy_ndp = 1
net.ipv6.conf.all.proxy_ndp = 1
</code></pre><p>保存后，重启系统或者执行 <code>sysctl -p</code> 使配置生效<h4>OpenVZ 配置</h4><p>检查 <code>/etc/vz/vz.conf</code> 中下面这行是没有注释的<pre><code>IPV6=&quot;yes&quot;
</code></pre><h3>分配 IPv6</h3><p>经过了前面的步骤之后，现在就可以正式去分配 IPv6 地址给 OpenVZ 虚拟机了。<p>Proxmox 的控制面板上面似乎并不支持分配 IPv6 地址，因此我们就在命令行下面进行，执行下面的语句即可<pre><code>vzctl set &lt;VEID&gt; --ipadd 2607:xxxx:xxxx:xxxx::3 --save
</code></pre><p>( 注意不要分配重复的地址&mldr;.<p>另外需要记住的是，除非这个 OpenVZ 虚拟机同时有 IPv4 的 nat 以及 IPv6 的地址，不然的话即可把虚拟机里面的 DNS 地址改成 ipv6 的 DNS ，不然的话就什么网站也上不去了。<h2>参考资料</h2><p><a href=http://robert.penz.name/582/ipv6-openvz-ves-and-debianproxmox-as-host-system/ rel=nofollow>IPv6 OpenVZ VEs and Debian/Proxmox as host system</a></div></div><div id=disqus_thread></div><div id=footer><span>Copyright © 2015 - 2020 imlonghao. Theme by
<a href=http://simiki.org/ target=_blank rel="noopener noreferrer">Simiki</a>. CC BY-NC-SA 4.0</span></div><script src=https://cdn.jsdelivr.net/npm/cfga@1.0.3/cfga.min.js integrity="sha256-TXHTTKAPRQ9mgacgN+couk0xnzQ6uOXTZ5ojH1q6GUk=" crossorigin=anonymous></script><script src=https://cdn.jsdelivr.net/npm/vanilla-lazyload@12.3.0/dist/lazyload.min.js integrity="sha256-bojBIKfs4l2WDcJODncBIGEe5fhU7/sM3zRO5/f2nqE=" crossorigin=anonymous async></script>